#!/bin/bash

set -e -x

JOB_NAME=mariadb
CONF_DIR=/var/vcap/jobs/${JOB_NAME}/config
PKG_DIR=/var/vcap/packages/${JOB_NAME}/${JOB_NAME}
DATA_DIR=/var/vcap/store/mariadb-data
ADMIN_PW="<%= p('admin.password')%>"

${PKG_DIR}/bin/mysql -u root < ${CONF_DIR}/user.sql

<% if spec.bootstrap -%>
if [ ! -d "$DATA_DIR/broker" ]; then
  echo "##### SERVICE-BROKER ::: DATABASE SCRIPT ::::: CREATE SCHEMA"
  ${PKG_DIR}/bin/mysql -u root < ${CONF_DIR}/init.sql
fi
<% end -%>
if [ ! -d "$DATA_DIR/test" ]; then
  rm -rf ${DATA_DIR}/test
fi

chmod 750 ${PKG_DIR}/support-files/mysql.server
